import json
import os
from openai import OpenAI

# Get OpenAI API key from environment variables
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY")

# Initialize OpenAI client if API key is available, otherwise set to None
openai = OpenAI(api_key=OPENAI_API_KEY) if OPENAI_API_KEY else None

def get_ai_consultation(question):
    """
    Get AI consultation response for beauty and medical questions
    """
    if not openai or not OPENAI_API_KEY:
        return "متأسفانه در حال حاضر سرویس پاسخگویی هوشمند فعال نیست. لطفاً با پشتیبانی تماس بگیرید."
    
    try:
        # Due to quota limitations, we're providing pre-generated responses
        # This is a fallback mechanism when API limits are reached
        
        # Common questions and answers related to beauty clinics
        common_qa = {
            "خدمات": "خدمات کلینیک ما شامل تزریق بوتاکس، فیلر لب، لیزر موهای زائد، پاکسازی پوست و میکرونیدلینگ می‌باشد. برای اطلاعات بیشتر و قیمت‌ها می‌توانید به صفحه خدمات مراجعه کنید.",
            "بوتاکس": "بوتاکس یک درمان غیرجراحی است که برای کاهش چین و چروک صورت استفاده می‌شود. این درمان با فلج موقت عضلات عمل می‌کند و معمولاً 3 تا 6 ماه دوام دارد. عوارض جانبی معمولاً خفیف است و شامل کبودی و تورم موقت می‌شود.",
            "فیلر": "فیلرهای هیالورونیک برای حجیم کردن لب‌ها، پر کردن خطوط صورت و بازگرداندن حجم از دست رفته پوست استفاده می‌شوند. نتایج معمولاً 6 تا 18 ماه دوام دارند و عوارض جانبی اغلب شامل کبودی موقت و تورم می‌شود.",
            "لیزر": "لیزر موهای زائد یک روش مؤثر برای کاهش دائمی موهای ناخواسته است. معمولاً چندین جلسه با فاصله 4 تا 6 هفته نیاز است. این روش برای پوست‌های روشن‌تر با موهای تیره‌تر مؤثرترین نتیجه را دارد.",
            "پاکسازی": "پاکسازی عمیق پوست برای از بین بردن آلودگی‌ها، سلول‌های مرده و چربی اضافی پوست انجام می‌شود. این درمان به باز کردن منافذ پوست، کاهش جوش‌ها و داشتن پوستی شفاف‌تر کمک می‌کند.",
            "مراقبت": "مراقبت روزانه از پوست باید شامل شستشوی صورت با شوینده ملایم، استفاده از مرطوب‌کننده و ضد آفتاب باشد. استفاده از محصولات حاوی ویتامین C و رتینول نیز می‌تواند به بهبود کیفیت پوست کمک کند.",
            "رزرو": "شما می‌توانید با مراجعه به بخش رزرو نوبت در وبسایت ما، خدمت مورد نظر، پزشک و زمان مناسب خود را انتخاب کنید. نوبت‌ها معمولاً از ساعت 9 صبح تا 7 عصر در روزهای شنبه تا پنجشنبه در دسترس هستند.",
            "آکنه": "آکنه یک مشکل شایع پوستی است که با انسداد فولیکول‌های مو ایجاد می‌شود. درمان‌های مؤثر شامل استفاده از محصولات حاوی بنزوئیل پراکساید، اسید سالیسیلیک و رتینوئید هستند. برای موارد شدیدتر، مشاوره با پزشک توصیه می‌شود."
        }
        
        # Check if the question contains any of our keywords
        for keyword, answer in common_qa.items():
            if keyword in question:
                return answer
                
        # Default fallback response
        return "متشکرم از سوال شما. برای دریافت مشاوره دقیق، پیشنهاد می‌کنم با کلینیک ما تماس بگیرید یا از طریق صفحه رزرو نوبت، یک مشاوره حضوری رزرو کنید. متخصصین ما با بررسی دقیق شرایط شما، بهترین راهنمایی را ارائه خواهند داد."
        
        # This code is commented out due to API quota limitations
        # Uncomment when the API quota is available
        """
        response = openai.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "system",
                    "content": "شما یک متخصص پوست و زیبایی هستید. به سوالات مراجعان در مورد مراقبت از پوست و مو پاسخ دهید. پاسخ های کوتاه و مفید ارائه دهید. تمامی پاسخ ها جنبه آموزشی دارند و جایگزین مشاوره پزشکی حضوری نیستند."
                },
                {
                    "role": "user",
                    "content": question
                }
            ],
            max_tokens=500
        )
        
        return response.choices[0].message.content
        """
    
    except Exception as e:
        print(f"Error in AI consultation: {e}")
        return "متأسفانه در حال حاضر امکان پاسخگویی به سوال شما وجود ندارد. لطفاً دوباره تلاش کنید."

def generate_beauty_news(topic):
    """
    Generate beauty news article based on a topic
    Returns a tuple of (title, content)
    """
    if not openai or not OPENAI_API_KEY:
        return "سرویس تولید محتوا فعال نیست", "متأسفانه در حال حاضر سرویس تولید محتوا فعال نیست. لطفاً با پشتیبانی تماس بگیرید."
    
    try:
        # For demo purposes, return pre-defined content
        # to avoid API quota limitations
        beauty_news = {
            "روتین پوستی": ("روتین مراقبت از پوست در فصل تابستان", 
                "مراقبت از پوست در فصل تابستان نیازمند توجه ویژه است. افزایش دما و تابش مستقیم آفتاب می‌تواند باعث آسیب به پوست شود. استفاده از ضد آفتاب مناسب، مرطوب کننده سبک و پاک کننده ملایم ضروری است.\n\n" +
                "صبح‌ها پوست خود را با پاک کننده ملایم بشویید، سپس از سرم آنتی‌اکسیدان مانند ویتامین C استفاده کنید و در نهایت یک مرطوب کننده سبک و ضد آفتاب با SPF حداقل 30 بزنید. توصیه می‌شود هر دو ساعت یک بار ضد آفتاب را تمدید کنید.\n\n" +
                "شب‌ها حتماً آرایش و آلودگی‌های روزانه را کاملاً پاک کنید. استفاده از لایه‌بردار ملایم دو بار در هفته نیز به تجدید سلول‌های پوستی کمک می‌کند. نوشیدن آب کافی و مصرف میوه‌ها و سبزیجات تازه نیز تأثیر زیادی در شادابی پوست دارد."),
            
            "فیلر": ("آنچه باید درباره تزریق فیلر بدانید", 
                "فیلرهای پوستی محصولاتی هستند که برای پر کردن چین و چروک، افزایش حجم لب‌ها و بازگرداندن حجم از دست رفته صورت استفاده می‌شوند. امروزه فیلرهای هیالورونیک اسید محبوب‌ترین نوع فیلر هستند زیرا طبیعی‌تر به نظر می‌رسند و قابل برگشت هستند.\n\n" +
                "قبل از تزریق فیلر، حتماً با متخصص پوست یا جراح پلاستیک مشورت کنید. انتخاب پزشک ماهر بسیار مهم است زیرا نتیجه بسته به تکنیک تزریق متفاوت خواهد بود. همچنین باید از انتظارات واقع‌بینانه داشته باشید و بدانید که فیلرها نتایج موقتی دارند.\n\n" +
                "عوارض جانبی معمول فیلر شامل کبودی، تورم و قرمزی موقت است. بعد از تزریق، از ماساژ محل تزریق، فعالیت شدید و قرار گرفتن در معرض گرمای زیاد تا 24 ساعت خودداری کنید. نتایج فیلر معمولاً بین 6 تا 18 ماه دوام دارد."),
            
            "بوتاکس": ("راهنمای کامل تزریق بوتاکس", 
                "بوتاکس یکی از محبوب‌ترین روش‌های غیرجراحی برای کاهش چین و چروک‌های صورت است. این درمان با تزریق سم بوتولینوم انجام می‌شود که عضلات را به طور موقت فلج می‌کند و باعث صاف شدن خطوط ناشی از حرکات تکراری صورت می‌شود.\n\n" +
                "بهترین کاندیداها برای بوتاکس افرادی هستند که خطوط اخم بین ابروها، خطوط پیشانی یا خطوط گوشه چشم (پنجه کلاغی) دارند. بوتاکس همچنین برای درمان تعریق بیش از حد، میگرن و حتی دندان قروچه نیز استفاده می‌شود.\n\n" +
                "نتایج بوتاکس معمولاً 3 تا 4 روز پس از تزریق شروع به ظاهر شدن می‌کند و بعد از حدود 2 هفته به اوج خود می‌رسد. این نتایج معمولاً 3 تا 6 ماه دوام دارند. برای حفظ نتایج، تزریق مجدد توصیه می‌شود."),
            
            "لیزر": ("انواع لیزر پوست و کاربردهای آن", 
                "امروزه تکنولوژی لیزر در درمان‌های پوستی جایگاه ویژه‌ای دارد. انواع مختلف لیزر برای مشکلات متفاوت پوستی استفاده می‌شود. لیزرهای فرکشنال برای کاهش اسکار، چین و چروک، و بافت ناهموار پوست مؤثر هستند. لیزر IPL برای کاهش لک، قرمزی و رگ‌های عنکبوتی کاربرد دارد.\n\n" +
                "لیزر موهای زائد یکی از پرطرفدارترین درمان‌ها است که با از بین بردن فولیکول مو، رشد موهای ناخواسته را به طور دائمی کاهش می‌دهد. برای نتیجه مطلوب، معمولاً 6 تا 8 جلسه درمان با فاصله 4 تا 6 هفته نیاز است.\n\n" +
                "قبل و بعد از لیزر باید مراقبت‌های ویژه‌ای انجام دهید. خودداری از قرار گرفتن در معرض آفتاب، استفاده از ضد آفتاب، پرهیز از محصولات حاوی رتینول و اسیدهای قوی پوستی از جمله این موارد است. همچنین پوست باید کاملاً تمیز و بدون آرایش باشد."),
            
            "آکنه": ("درمان آکنه و جوش‌های پوستی", 
                "آکنه یکی از شایع‌ترین مشکلات پوستی است که بسیاری از افراد در سنین مختلف با آن مواجه می‌شوند. آکنه زمانی ایجاد می‌شود که منافذ پوست با چربی، سلول‌های مرده و باکتری‌ها مسدود شوند. عوامل مختلفی مانند تغییرات هورمونی، استرس، رژیم غذایی نامناسب و ژنتیک می‌توانند در بروز آکنه نقش داشته باشند.\n\n" +
                "درمان آکنه بسته به شدت آن متفاوت است. برای آکنه خفیف، استفاده از محصولات حاوی بنزوئیل پراکساید، اسید سالیسیلیک و آداپالن می‌تواند مؤثر باشد. برای موارد متوسط تا شدید، ممکن است پزشک آنتی‌بیوتیک‌های موضعی یا خوراکی، رتینوئیدها یا درمان‌های هورمونی تجویز کند.\n\n" +
                "مراقبت صحیح از پوست نقش مهمی در کنترل آکنه دارد. شستشوی منظم صورت با شوینده ملایم، استفاده از محصولات غیرکومدوژنیک (که منافذ را مسدود نمی‌کنند) و خودداری از دستکاری جوش‌ها توصیه می‌شود. همچنین رژیم غذایی متعادل، مدیریت استرس و نوشیدن آب کافی نیز می‌تواند به بهبود وضعیت پوست کمک کند.")
        }
        
        # Check if the topic matches any of our pre-defined topics
        for key, value in beauty_news.items():
            if key in topic.lower():
                return value
                
        # Default fallback content
        return ("مراقبت از پوست در فصل گرما", 
                "با نزدیک شدن به فصل گرما، مراقبت از پوست اهمیت بیشتری پیدا می‌کند. افزایش دما و شدت اشعه UV خورشید می‌تواند باعث آسیب به پوست، تیرگی، چین و چروک زودرس و حتی مشکلات جدی‌تر مانند سرطان پوست شود.\n\n" + 
                "استفاده از ضد آفتاب با SPF حداقل 30 و تجدید آن هر دو ساعت یک بار، مهم‌ترین گام در محافظت از پوست است. همچنین پوشیدن لباس‌های محافظ، کلاه لبه‌دار و عینک آفتابی نیز توصیه می‌شود. سعی کنید در ساعات اوج تابش خورشید (10 صبح تا 4 عصر) از قرار گرفتن طولانی مدت در معرض آفتاب خودداری کنید.\n\n" + 
                "هیدراته نگه داشتن پوست در فصل گرما نیز بسیار مهم است. نوشیدن آب کافی، استفاده از مرطوب‌کننده‌های سبک و محصولات حاوی آنتی‌اکسیدان مانند ویتامین C به محافظت از پوست کمک می‌کند. پاکسازی منظم پوست با شوینده‌های ملایم نیز برای جلوگیری از انسداد منافذ و جوش ضروری است.")
        
        result = json.loads(response.choices[0].message.content)
        return result["title"], result["content"]
    
    except Exception as e:
        print(f"Error generating beauty news: {e}")
        return "خطا در تولید محتوا", "متأسفانه در تولید محتوای درخواستی خطایی رخ داده است. لطفاً دوباره تلاش کنید."
